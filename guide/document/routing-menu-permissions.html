<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>路由菜单权限控制 | 前端开发规范&amp;文档</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/developdoc/favicon.ico">
    <meta name="description" content="前端开发规范&文档">
    <link rel="preload" href="/developdoc/assets/css/0.styles.ef384e93.css" as="style"><link rel="preload" href="/developdoc/assets/js/app.0ef85107.js" as="script"><link rel="preload" href="/developdoc/assets/js/2.416b7026.js" as="script"><link rel="preload" href="/developdoc/assets/js/15.3b17ec5e.js" as="script"><link rel="prefetch" href="/developdoc/assets/js/10.71768a4f.js"><link rel="prefetch" href="/developdoc/assets/js/11.71d24637.js"><link rel="prefetch" href="/developdoc/assets/js/12.aebaac81.js"><link rel="prefetch" href="/developdoc/assets/js/13.55eaab9b.js"><link rel="prefetch" href="/developdoc/assets/js/14.beeb2d7e.js"><link rel="prefetch" href="/developdoc/assets/js/16.7736a91a.js"><link rel="prefetch" href="/developdoc/assets/js/17.0c57e85c.js"><link rel="prefetch" href="/developdoc/assets/js/18.22cd0e18.js"><link rel="prefetch" href="/developdoc/assets/js/19.7c120dfa.js"><link rel="prefetch" href="/developdoc/assets/js/3.1f893780.js"><link rel="prefetch" href="/developdoc/assets/js/4.9feeae3b.js"><link rel="prefetch" href="/developdoc/assets/js/5.fb165bb9.js"><link rel="prefetch" href="/developdoc/assets/js/6.1f79d78a.js"><link rel="prefetch" href="/developdoc/assets/js/7.ff826a3d.js"><link rel="prefetch" href="/developdoc/assets/js/8.fdb64087.js"><link rel="prefetch" href="/developdoc/assets/js/9.7c267cf6.js">
    <link rel="stylesheet" href="/developdoc/assets/css/0.styles.ef384e93.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/developdoc/" class="home-link router-link-active"><!----> <span class="site-name">前端开发规范&amp;文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发规范</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/developdoc/guide/specification/" class="sidebar-link">介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue从零开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/developdoc/guide/document/introduction.html" class="sidebar-link">介绍</a></li><li><a href="/developdoc/guide/document/front-end-environment-set-up.html" class="sidebar-link">前端环境搭建</a></li><li><a href="/developdoc/guide/document/code-structure.html" class="sidebar-link">代码结构</a></li><li><a href="/developdoc/guide/document/a-unified-code-style.html" class="sidebar-link">统一代码风格</a></li><li><a href="/developdoc/guide/document/many-environment-configuration.html" class="sidebar-link">多环境配置</a></li><li><a href="/developdoc/guide/document/global-state-management.html" class="sidebar-link">全局状态管理</a></li><li><a href="/developdoc/guide/document/network-request-package.html" class="sidebar-link">网络请求封装</a></li><li><a href="/developdoc/guide/document/chart.html" class="sidebar-link">工作台页面</a></li><li><a href="/developdoc/guide/document/form.html" class="sidebar-link">收据开具页面</a></li><li><a href="/developdoc/guide/document/table.html" class="sidebar-link">收据审核、查询、打印、收款页面</a></li><li><a href="/developdoc/guide/document/third-party-relies-on.html" class="sidebar-link">收据打印页面</a></li><li><a href="/developdoc/guide/document/routing-menu-permissions.html" aria-current="page" class="active sidebar-link">路由菜单权限控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#修改用户信息相关mock" class="sidebar-link">修改用户信息相关Mock</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#修改状态管理" class="sidebar-link">修改状态管理</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#配置路由" class="sidebar-link">配置路由</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#过滤权限相关方法" class="sidebar-link">过滤权限相关方法</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#路由守卫" class="sidebar-link">路由守卫</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#指令权限" class="sidebar-link">指令权限</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#效果图" class="sidebar-link">效果图</a></li><li class="sidebar-sub-header"><a href="/developdoc/guide/document/routing-menu-permissions.html#原理图" class="sidebar-link">原理图</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="路由菜单权限控制"><a href="#路由菜单权限控制" class="header-anchor">#</a> 路由菜单权限控制</h1> <p>到这里基本上所有的页面都已经开发完成了，现在我们需要对菜单做一个权限控制，需求如下：</p> <ul><li>xiaoMing账号下可见页面为：工作台、收据开具、收据审核、收据查询、收据打印</li> <li>xiaoHong账号下可见页面为：工作台、收据收款、收据查询</li></ul> <h2 id="修改用户信息相关mock"><a href="#修改用户信息相关mock" class="header-anchor">#</a> 修改用户信息相关Mock</h2> <p>修改src/mock/services/auth.js文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Mock <span class="token keyword">from</span> <span class="token string">'mockjs2'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> builder<span class="token punctuation">,</span> getBody <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util'</span>

<span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'xiaoMing'</span><span class="token punctuation">,</span> <span class="token string">'xiaoHong'</span><span class="token punctuation">]</span>
<span class="token comment">// 强硬要求 ant.design 相同密码</span>
<span class="token comment">// '21232f297a57a5a743894a0e4a801fc3',</span>
<span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'8914de686ab28dc22f30d3d8e107ff6c'</span><span class="token punctuation">,</span> <span class="token string">'21232f297a57a5a743894a0e4a801fc3'</span><span class="token punctuation">]</span> <span class="token comment">// admin, ant.design</span>

<span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token function">getBody</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mock: body'</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>username<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isLogin<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'账户或密码错误'</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">builder</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      id<span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'@guid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'@name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> body<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      avatar<span class="token operator">:</span> <span class="token string">'https://gw.alipayobjects.com/zos/rmsportal/jZUIxmJycoymBprLOUbT.png'</span><span class="token punctuation">,</span>
      status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      telephone<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      lastLoginIp<span class="token operator">:</span> <span class="token string">'27.154.74.117'</span><span class="token punctuation">,</span>
      lastLoginTime<span class="token operator">:</span> <span class="token number">1534837621348</span><span class="token punctuation">,</span>
      creatorId<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
      createTime<span class="token operator">:</span> <span class="token number">1497160610259</span><span class="token punctuation">,</span>
      deleted<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      roleId<span class="token operator">:</span> body<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
      lang<span class="token operator">:</span> <span class="token string">'zh-CN'</span><span class="token punctuation">,</span>
      token<span class="token operator">:</span> <span class="token string">'4291d7da9005377ec9aec4a71ea837f'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">'Custom-Header'</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'@guid'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">logout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'[测试接口] 注销成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">smsCaptcha</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">{</span> captcha<span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'@integer(10000, 99999)'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">twofactor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stepCode<span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'@integer(0, 1)'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token regex">/\/auth\/login/</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> login<span class="token punctuation">)</span>
Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token regex">/\/auth\/logout/</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> logout<span class="token punctuation">)</span>
Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token regex">/\/account\/sms/</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> smsCaptcha<span class="token punctuation">)</span>
Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token regex">/\/auth\/2step-code/</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> twofactor<span class="token punctuation">)</span>
</code></pre></div><p>修改src/mock/services/user.js文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Mock <span class="token keyword">from</span> <span class="token string">'mockjs2'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> builder<span class="token punctuation">,</span> getBody <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util'</span>

<span class="token keyword">const</span> <span class="token function-variable function">info</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'options'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token function">getBody</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'4291d7da9005377ec9aec4a71ea837f'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'天野远子'</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> body<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    avatar<span class="token operator">:</span> <span class="token string">'/avatar2.jpg'</span><span class="token punctuation">,</span>
    status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    telephone<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    lastLoginIp<span class="token operator">:</span> <span class="token string">'27.154.74.117'</span><span class="token punctuation">,</span>
    lastLoginTime<span class="token operator">:</span> <span class="token number">1534837621348</span><span class="token punctuation">,</span>
    creatorId<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
    createTime<span class="token operator">:</span> <span class="token number">1497160610259</span><span class="token punctuation">,</span>
    merchantCode<span class="token operator">:</span> <span class="token string">'TLif2btpzg079h15bk'</span><span class="token punctuation">,</span>
    deleted<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    roleId<span class="token operator">:</span> body<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
    role<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>roleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'xiaoMing'</span><span class="token operator">:</span>
      userInfo<span class="token punctuation">.</span>role <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token string">'xiaoMing'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'管理员'</span><span class="token punctuation">,</span>
        describe<span class="token operator">:</span> <span class="token string">'拥有所有权限'</span><span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoMing'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'workSpace'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'工作台'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                action<span class="token operator">:</span> <span class="token string">'receiptIssued'</span><span class="token punctuation">,</span>
                describe<span class="token operator">:</span> <span class="token string">'收据开具'</span><span class="token punctuation">,</span>
                defaultCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                action<span class="token operator">:</span> <span class="token string">'receiptAudit'</span><span class="token punctuation">,</span>
                describe<span class="token operator">:</span> <span class="token string">'收据审核'</span><span class="token punctuation">,</span>
                defaultCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                action<span class="token operator">:</span> <span class="token string">'receiptQuery'</span><span class="token punctuation">,</span>
                describe<span class="token operator">:</span> <span class="token string">'收据查询'</span><span class="token punctuation">,</span>
                defaultCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                action<span class="token operator">:</span> <span class="token string">'receiptPrintList'</span><span class="token punctuation">,</span>
                describe<span class="token operator">:</span> <span class="token string">'收据打印'</span><span class="token punctuation">,</span>
                defaultCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoMing'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'receiptIssued'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'收据开具'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoMing'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'receiptAudit'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'收据审核'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoMing'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'receiptPrintList'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'收据打印'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoMing'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'receiptQuery'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'收据查询'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'xiaoHong'</span><span class="token operator">:</span>
      userInfo<span class="token punctuation">.</span>role <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token string">'xiaoHong'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'管理员'</span><span class="token punctuation">,</span>
        describe<span class="token operator">:</span> <span class="token string">'拥有所有权限'</span><span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoHong'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'workSpace'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'工作台'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                action<span class="token operator">:</span> <span class="token string">'receiptCollection'</span><span class="token punctuation">,</span>
                describe<span class="token operator">:</span> <span class="token string">'收据收款'</span><span class="token punctuation">,</span>
                defaultCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                action<span class="token operator">:</span> <span class="token string">'receiptQuery'</span><span class="token punctuation">,</span>
                describe<span class="token operator">:</span> <span class="token string">'收据查询'</span><span class="token punctuation">,</span>
                defaultCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoHong'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'receiptCollection'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'收据收款'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            roleId<span class="token operator">:</span> <span class="token string">'xiaoHong'</span><span class="token punctuation">,</span>
            permissionId<span class="token operator">:</span> <span class="token string">'receiptQuery'</span><span class="token punctuation">,</span>
            permissionName<span class="token operator">:</span> <span class="token string">'收据查询'</span><span class="token punctuation">,</span>
            actionEntitySet<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            actionList<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            dataAccess<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">builder</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token regex">/\/api\/user\/info/</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span>
</code></pre></div><h2 id="修改状态管理"><a href="#修改状态管理" class="header-anchor">#</a> 修改状态管理</h2> <p>这里登录过程就不讲了~主要讲用户登录过后，通过根据抓取到的用户信息里面的角色来进行权限分配，这里用到了Vuex(全局状态管理)，它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。我们只需要把一些频繁使用的值(例如：用户信息、角色权限等)定义在VueX中，即可在整个Vue项目的组件中使用。</p> <p>修改src/store/modules/user.js文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> storage <span class="token keyword">from</span> <span class="token string">'store'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> login<span class="token punctuation">,</span> getInfo<span class="token punctuation">,</span> logout <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/api/login'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ACCESS_TOKEN</span><span class="token punctuation">,</span> <span class="token constant">USER_NAME</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/store/mutation-types'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> welcome <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils/util'</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>
    token<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    welcome<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    avatar<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    info<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">SET_TOKEN</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> token</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>token <span class="token operator">=</span> token
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">SET_NAME</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> welcome <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>name <span class="token operator">=</span> name
      state<span class="token punctuation">.</span>welcome <span class="token operator">=</span> welcome
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">SET_AVATAR</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> avatar</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>avatar <span class="token operator">=</span> avatar
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">SET_ROLES</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> roles</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>roles <span class="token operator">=</span> roles
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">SET_INFO</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>info <span class="token operator">=</span> info
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  actions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 登录</span>
    <span class="token function">Login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> userInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">login</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> response<span class="token punctuation">.</span>result
            storage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">ACCESS_TOKEN</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_TOKEN'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
            storage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">USER_NAME</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token comment">// 缓存用户名</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取用户信息</span>
    <span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token operator">:</span> storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">USER_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 这里传一个用户名</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> response<span class="token punctuation">.</span>result

            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>role <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>role<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> role <span class="token operator">=</span> result<span class="token punctuation">.</span>role
              role<span class="token punctuation">.</span>permissions <span class="token operator">=</span> result<span class="token punctuation">.</span>role<span class="token punctuation">.</span>permissions
              role<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">per</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>per<span class="token punctuation">.</span>actionEntitySet <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> per<span class="token punctuation">.</span>actionEntitySet<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">const</span> action <span class="token operator">=</span> per<span class="token punctuation">.</span>actionEntitySet<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> action<span class="token punctuation">.</span>action
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  per<span class="token punctuation">.</span>actionList <span class="token operator">=</span> action
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              role<span class="token punctuation">.</span>permissionList <span class="token operator">=</span> role<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">permission</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> permission<span class="token punctuation">.</span>permissionId
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROLES'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>role<span class="token punctuation">)</span>
              <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_INFO'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'getInfo: roles must be a non-null array !'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_NAME'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> result<span class="token punctuation">.</span>name<span class="token punctuation">,</span> welcome<span class="token operator">:</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_AVATAR'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>avatar<span class="token punctuation">)</span>

            <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 登出</span>
    <span class="token function">Logout</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit<span class="token punctuation">,</span> state <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">logout</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_TOKEN'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROLES'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            storage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">ACCESS_TOKEN</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> user
</code></pre></div><h2 id="配置路由"><a href="#配置路由" class="header-anchor">#</a> 配置路由</h2> <p>修改src/config/router.config.js文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// eslint-disable-next-line</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserLayout<span class="token punctuation">,</span> BasicLayout<span class="token punctuation">,</span> BlankLayout <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/layouts'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bxAnaalyse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/core/icons'</span>

<span class="token comment">// const RouteView = {</span>
<span class="token comment">//   name: 'RouteView',</span>
<span class="token comment">//   render: (h) =&gt; h('router-view'),</span>
<span class="token comment">// }</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> asyncRouterMap <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'index'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> BasicLayout<span class="token punctuation">,</span>
    meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'首页'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> <span class="token string">'/work-space'</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'work-space'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'workSpace'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/dashboard/WorkSpace'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'工作台'</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> bxAnaalyse<span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'workSpace'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'receipt-issued'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'receiptIssued'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/receiptIssu/ReceiptIssu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'收据开具'</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> bxAnaalyse<span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'receiptIssued'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'receipt-collection'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'receiptCollection'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/receiptPayment/ReceiptPayment'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'收据收款'</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> bxAnaalyse<span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'receiptCollection'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'receipt-audit'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'receiptAudit'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/receiptAudit/ReceiptAudit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'收据审核'</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> bxAnaalyse<span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'receiptAudit'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'receipt-query'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'receiptQuery'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/receiptTheQuery/ReceiptTheQuery'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'收据查询'</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> bxAnaalyse<span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'receiptQuery'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'receipt-print-list'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'receiptPrintList'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/receiptPrintList/ReceiptPrintList'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'收据打印'</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> bxAnaalyse<span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'receiptPrintList'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'receipt-print'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'receiptPrint'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/receiptPrint/ReceiptPrint'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'收据打印详情'</span><span class="token punctuation">,</span> permission<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'receiptPrintList'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        hidden<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> <span class="token string">'/404'</span><span class="token punctuation">,</span>
    hidden<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">/**
 * 基础路由
 * @type { *[] }
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> constantRouterMap <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/user'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> UserLayout<span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> <span class="token string">'/user/login'</span><span class="token punctuation">,</span>
    hidden<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'login'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'login'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;user&quot; */</span> <span class="token string">'@/views/user/Login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p><code>{ Route }</code> 对象</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">说明</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">默认值</th></tr></thead> <tbody><tr><td style="text-align:left;">hidden</td> <td style="text-align:left;">控制路由和子路由是否显示在 菜单</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">false</td></tr> <tr><td style="text-align:left;">redirect</td> <td style="text-align:left;">重定向地址, 访问这个路由时,自定进行重定向</td> <td style="text-align:left;">string</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">name</td> <td style="text-align:left;">路由名称, 必须设置,且不能重名</td> <td style="text-align:left;">string</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">meta</td> <td style="text-align:left;">路由元信息（路由附带扩展信息）</td> <td style="text-align:left;">object</td> <td style="text-align:left;">{}</td></tr> <tr><td style="text-align:left;">hideChildrenInMenu</td> <td style="text-align:left;">强制菜单显示为Item而不是SubItem(配合 meta.hidden)</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">-</td></tr></tbody></table> <p><code>{ Meta }</code> 路由元信息对象</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">说明</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">默认值</th></tr></thead> <tbody><tr><td style="text-align:left;">title</td> <td style="text-align:left;">路由标题, 用于显示面包屑, 页面标题</td> <td style="text-align:left;">string</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">icon</td> <td style="text-align:left;">路由在 菜单 上显示的图标</td> <td style="text-align:left;">[string,svg]</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">keepAlive</td> <td style="text-align:left;">缓存该路由 (开启 multi-tab 是默认值为 true)</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">false</td></tr> <tr><td style="text-align:left;">hiddenHeaderContent</td> <td style="text-align:left;">*特殊 隐藏 <a href="https://github.com/sendya/ant-design-pro-vue/blob/master/src/components/layout/PageHeader.vue#L14" target="_blank" rel="noopener noreferrer">PageHeader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 组件中的页面带的 面包屑和页面标题栏</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">false</td></tr> <tr><td style="text-align:left;">permission</td> <td style="text-align:left;">与项目提供的权限拦截匹配的权限，如果不匹配，则会被禁止访问该路由页面</td> <td style="text-align:left;">array</td> <td style="text-align:left;">[]</td></tr></tbody></table> <h2 id="过滤权限相关方法"><a href="#过滤权限相关方法" class="header-anchor">#</a> 过滤权限相关方法</h2> <p>在src/store/modules/permission.js存放着过滤权限的相关方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> asyncRouterMap<span class="token punctuation">,</span> constantRouterMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/config/router.config'</span>

<span class="token comment">/**
 * 过滤账户是否拥有某一个权限，并将菜单从加载列表移除
 *
 * @param permission
 * @param route
 * @returns {boolean}
 */</span>
<span class="token keyword">function</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token parameter">permission<span class="token punctuation">,</span> route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> permission<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      flag <span class="token operator">=</span> route<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>permission<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 单账户多角色时，使用该方法可过滤角色不存在的菜单
 *
 * @param roles
 * @param route
 * @returns {*}
 */</span>
<span class="token comment">// eslint-disable-next-line</span>
<span class="token keyword">function</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token parameter">roles<span class="token punctuation">,</span> route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> route<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>roles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">filterAsyncRouter</span><span class="token punctuation">(</span><span class="token parameter">routerMap<span class="token punctuation">,</span> roles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> accessedRouters <span class="token operator">=</span> routerMap<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">route</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasPermission</span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span>permissionList<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        route<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">filterAsyncRouter</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">,</span> roles<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> accessedRouters
<span class="token punctuation">}</span>

<span class="token keyword">const</span> permission <span class="token operator">=</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>
    routers<span class="token operator">:</span> constantRouterMap<span class="token punctuation">,</span>
    addRouters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">SET_ROUTERS</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> routers</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>addRouters <span class="token operator">=</span> routers
      state<span class="token punctuation">.</span>routers <span class="token operator">=</span> constantRouterMap<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>routers<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">GenerateRoutes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> roles <span class="token punctuation">}</span> <span class="token operator">=</span> data
        <span class="token keyword">const</span> accessedRouters <span class="token operator">=</span> <span class="token function">filterAsyncRouter</span><span class="token punctuation">(</span>asyncRouterMap<span class="token punctuation">,</span> roles<span class="token punctuation">)</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROUTERS'</span><span class="token punctuation">,</span> accessedRouters<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> permission
</code></pre></div><h2 id="路由守卫"><a href="#路由守卫" class="header-anchor">#</a> 路由守卫</h2> <p>正如其名，<code>vue-router</code> 提供的守卫主要用来通过跳转或取消的方式守卫路由。在路由守卫里，可以判断当前要进入的路由页面是否在当前角色的路由表里，以此来判断是否放行。</p> <p><code>main.js</code>目录下<code>permission.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token keyword">import</span> storage <span class="token keyword">from</span> <span class="token string">'store'</span>
<span class="token keyword">import</span> NProgress <span class="token keyword">from</span> <span class="token string">'nprogress'</span> <span class="token comment">// progress bar</span>
<span class="token keyword">import</span> <span class="token string">'@/components/NProgress/nprogress.less'</span> <span class="token comment">// progress bar custom style</span>
<span class="token keyword">import</span> notification <span class="token keyword">from</span> <span class="token string">'ant-design-vue/es/notification'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setDocumentTitle<span class="token punctuation">,</span> domTitle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils/domUtil'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ACCESS_TOKEN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/store/mutation-types'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> i18nRender <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/locales'</span>

NProgress<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showSpinner<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// NProgress Configuration</span>

<span class="token keyword">const</span> whiteList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token string">'register'</span><span class="token punctuation">,</span> <span class="token string">'registerResult'</span><span class="token punctuation">]</span> <span class="token comment">// no redirect whitelist</span>
<span class="token keyword">const</span> loginRoutePath <span class="token operator">=</span> <span class="token string">'/user/login'</span>
<span class="token keyword">const</span> defaultRoutePath <span class="token operator">=</span> <span class="token string">'/dashboard/workplace'</span>

router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// start progress bar</span>
  to<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>title <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">setDocumentTitle</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">i18nRender</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domTitle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">/* has token */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ACCESS_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> loginRoutePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> defaultRoutePath <span class="token punctuation">}</span><span class="token punctuation">)</span>
      NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// check login user.roles is null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>roles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// request login userInfo</span>
        store
          <span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GetInfo'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> roles <span class="token operator">=</span> res<span class="token punctuation">.</span>result <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">.</span>role
            <span class="token comment">// generate dynamic router</span>
            store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GenerateRoutes'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> roles <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// 根据roles权限生成可访问的路由表</span>
              <span class="token comment">// 动态添加可访问路由表</span>
              router<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>addRouters<span class="token punctuation">)</span>
              <span class="token comment">// 请求带有 redirect 重定向时，登录自动重定向到该地址</span>
              <span class="token keyword">const</span> redirect <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>redirect <span class="token operator">||</span> to<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// set the replace: true so the navigation will not leave a history record</span>
                <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>to<span class="token punctuation">,</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 跳转到目的路由</span>
                <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> redirect <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            notification<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              message<span class="token operator">:</span> <span class="token string">'错误'</span><span class="token punctuation">,</span>
              description<span class="token operator">:</span> <span class="token string">'请求用户信息失败，请重试'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">// 失败时，获取用户信息失败时，调用登出，来清空历史保留信息</span>
            store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'Logout'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> loginRoutePath<span class="token punctuation">,</span> query<span class="token operator">:</span> <span class="token punctuation">{</span> redirect<span class="token operator">:</span> to<span class="token punctuation">.</span>fullPath <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在免登录白名单，直接进入</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> loginRoutePath<span class="token punctuation">,</span> query<span class="token operator">:</span> <span class="token punctuation">{</span> redirect<span class="token operator">:</span> to<span class="token punctuation">.</span>fullPath <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// if current page is login will not trigger afterEach hook, so manually handle it</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// finish progress bar</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="指令权限"><a href="#指令权限" class="header-anchor">#</a> 指令权限</h2> <p>在实际应用中，不止菜单有权限控制，页面上的组件、按钮之类的也会有权限控制，就像我在前言里说的一些角色他们能看到同一个页面，但是其中一个只能查看看，而另一个就可以编辑。这里我们可以通过自定义指令来实现，在配置角色权限里有一个actionEntitySet数组，这里存放的就是这类权限。</p> <p>新建一个自定义指令<code>action.js</code>，然后在<code>main.js</code>里引入即可</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'@/store'</span>

<span class="token comment">/**
 * Action 权限指令
 * 指令用法：
 *  - 在需要控制 action 级别权限的组件上使用 v-action:[method] , 如下：
 *    &lt;i-button v-action:add &gt;添加用户&lt;/a-button&gt;
 *    &lt;a-button v-action:delete&gt;删除用户&lt;/a-button&gt;
 *    &lt;a v-action:edit @click=&quot;edit(record)&quot;&gt;修改&lt;/a&gt;
 *
 *  - 当前用户没有权限时，组件上使用了该指令则会被隐藏
 *  - 当后台权限跟 pro 提供的模式不同时，只需要针对这里的权限过滤进行修改即可
 *
 *  @see https://github.com/vueComponent/ant-design-vue-pro/pull/53
 */</span>
<span class="token keyword">const</span> action <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> actionName <span class="token operator">=</span> binding<span class="token punctuation">.</span>arg
    <span class="token keyword">const</span> roles <span class="token operator">=</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>roles
    <span class="token keyword">const</span> elVal <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$route<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>permission
    <span class="token keyword">const</span> permissionId <span class="token operator">=</span> <span class="token punctuation">(</span>elVal <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span>elVal<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> elVal
    roles<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permissionId<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>permissionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>actionList <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>actionList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>actionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">;</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>parentNode <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> action
</code></pre></div><h2 id="效果图"><a href="#效果图" class="header-anchor">#</a> 效果图</h2> <ul><li><p>xiaoMing</p> <p><img src="https://figure-b.ricardolsw.com/image/xiaoming.png" alt="xiaoming"></p></li> <li><p>xiaoHong</p> <p><img src="https://figure-b.ricardolsw.com/image/xiaohong.png" alt="xiaohong"></p></li></ul> <h2 id="原理图"><a href="#原理图" class="header-anchor">#</a> 原理图</h2> <p><img src="https://figure-b.ricardolsw.com/image/watermark.png" alt=""></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/3/2020, 1:38:21 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/developdoc/guide/document/third-party-relies-on.html" class="prev">
        收据打印页面
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/developdoc/assets/js/app.0ef85107.js" defer></script><script src="/developdoc/assets/js/2.416b7026.js" defer></script><script src="/developdoc/assets/js/15.3b17ec5e.js" defer></script>
  </body>
</html>
